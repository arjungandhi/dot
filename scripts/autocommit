#!/usr/bin/bash
# autocommit watches a directory and commits and push on file change

autocommit() {
    [[ -z "$1" ]] && echo "Usage: autocommit file" && return 1

    # check the directory exists and is a git repo
    [[ ! -d "$1" ]] && echo "Directory $1 does not exist" && return 1
    [[ ! -d "$1/.git" ]] && echo "Directory $1 is not a git repo" && return 1

    path=$(readlink -e "$1")

    while true; do
    	inotifywait --recursive --exclude '\.git' -e attrib,create,delete,modify,delete_self,move,move_self,close_write $path
    	cd $path                              &> /dev/null
        sleep 30s                             &> /dev/null

    	# Stage and commit local changes first
    	git add --all                         &> /dev/null
    	now=$(date)                           &> /dev/null

    	if ! git commit -m "Auto-Commit at : $now" &> /dev/null; then
    	    # Commit can fail if there are no changes, which is fine
    	    continue
    	fi

    	# Pull remote changes after committing local changes
    	if ! git pull &> /dev/null; then
    	    notify-send -u critical "Auto-commit Failed" "git pull failed in $path"
    	    continue
    	fi

    	# Push combined changes
    	if ! git push &> /dev/null; then
    	    notify-send -u critical "Auto-commit Failed" "git push failed in $path"
    	fi
    done

}

autocommit $@
