#!/bin/bash
# OBS Quick Record Toggle
# Auto-starts OBS, switches to recording scene, and toggles recording

# Configuration
OBS_HOST="localhost"
OBS_PORT="4455"  # OBS Studio 28+ uses port 4455 by default
NOTIFICATION_TIMEOUT=2000  # milliseconds
RECORDING_SCENE="Quick Demo"  # Name of the scene to use for recording
OBS_STARTUP_WAIT=3  # Seconds to wait for OBS to start

# Check if OBS is running, if not start it
if ! pgrep -x obs > /dev/null; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "Starting OBS..."
    obs --minimize-to-tray --scene "$RECORDING_SCENE" &>/dev/null &
    sleep $OBS_STARTUP_WAIT
fi

# Use Python to control OBS via WebSocket v5
python3 << 'PYTHON_SCRIPT'
import sys
from obsws_python import ReqClient
import os

host = "localhost"
port = 4455
password = ""

try:
    cl = ReqClient(host=host, port=port, password=password)

    # Try to switch to the recording scene if it exists
    try:
        scenes = cl.get_scene_list()
        scene_names = [scene['sceneName'] for scene in scenes.scenes]

        if "Quick Demo" in scene_names:
            current_scene = cl.get_current_program_scene()
            if current_scene.current_program_scene_name != "Quick Demo":
                cl.set_current_program_scene("Quick Demo")
    except Exception as e:
        pass  # Scene might not exist yet, that's okay

    # Toggle recording
    cl.toggle_record()

    # Get recording status
    status = cl.get_record_status()
    is_recording = status.output_active

    # Exit with code to indicate recording status (0=started, 1=stopped)
    sys.exit(0 if is_recording else 1)

except Exception as e:
    os.system(f'notify-send -t 2000 "OBS Recording" "Error: {str(e)}"')
    sys.exit(2)
PYTHON_SCRIPT

# Check exit code and show notification
EXIT_CODE=$?
if [ $EXIT_CODE -eq 0 ]; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "ðŸ”´ Recording started"
elif [ $EXIT_CODE -eq 1 ]; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "â¹ï¸ Recording stopped"
fi
