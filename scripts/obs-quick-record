#!/bin/bash
# OBS Quick Record Toggle
# Auto-starts OBS, switches to recording scene, and toggles recording

# Configuration
OBS_HOST="localhost"
OBS_PORT="4455"  # OBS Studio 28+ uses port 4455 by default
NOTIFICATION_TIMEOUT=2000  # milliseconds
RECORDING_SCENE="Quick Demo"  # Name of the scene to use for recording
OBS_STARTUP_WAIT=3  # Seconds to wait for OBS to start

# Check if OBS is running, if not start it
if ! pgrep -x obs > /dev/null; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "Starting OBS..."
    obs --minimize-to-tray --scene "$RECORDING_SCENE" &>/dev/null &
    sleep $OBS_STARTUP_WAIT
fi

# Use Python to control OBS via WebSocket v5
python3 << 'PYTHON_SCRIPT'
import sys
from obswebsocket import obsws, requests
from obswebsocket.exceptions import ConnectionFailure
import os

host = "localhost"
port = 4455
password = ""

try:
    ws = obsws(host, port, password)
    ws.connect()

    # Try to switch to the recording scene if it exists
    try:
        scenes = ws.call(requests.GetSceneList())
        scene_names = [scene['sceneName'] for scene in scenes.getScenes()]

        if "Quick Demo" in scene_names:
            current_scene = ws.call(requests.GetCurrentProgramScene())
            if current_scene.getCurrentProgramSceneName() != "Quick Demo":
                ws.call(requests.SetCurrentProgramScene(sceneName="Quick Demo"))
    except Exception as e:
        pass  # Scene might not exist yet, that's okay

    # Toggle recording
    ws.call(requests.ToggleRecord())

    # Get recording status
    status = ws.call(requests.GetRecordStatus())
    is_recording = status.getOutputActive()

    ws.disconnect()

    # Exit with code to indicate recording status (0=started, 1=stopped)
    sys.exit(0 if is_recording else 1)

except ConnectionFailure:
    os.system(f'notify-send -t 2000 "OBS Recording" "Failed to connect to OBS WebSocket"')
    sys.exit(2)
except Exception as e:
    os.system(f'notify-send -t 2000 "OBS Recording" "Error: {str(e)}"')
    sys.exit(2)
PYTHON_SCRIPT

# Check exit code and show notification
EXIT_CODE=$?
if [ $EXIT_CODE -eq 0 ]; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "ðŸ”´ Recording started"
elif [ $EXIT_CODE -eq 1 ]; then
    notify-send -t $NOTIFICATION_TIMEOUT "OBS Recording" "â¹ï¸ Recording stopped"
fi
